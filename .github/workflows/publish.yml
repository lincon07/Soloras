name: publish

on:
  push:
    branches:
      - main

jobs:
  publish-tauri:
    permissions:
      contents: write

    runs-on: ubuntu-22.04

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # Node.js
      # -----------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      # -----------------------------
      # Rust + ARM target
      # -----------------------------
      - name: Install Rust stable (ARM64 target)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      # -----------------------------
      # Linux dependencies (Tauri v2)
      # -----------------------------
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      # -----------------------------
      # Force ARM linker (CRITICAL)
      # -----------------------------
      - name: Configure ARM64 linker
        run: |
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      # -----------------------------
      # Frontend dependencies
      # -----------------------------
      - name: Install frontend dependencies
        run: yarn install --frozen-lockfile

      # -----------------------------
      # Build + Release (ARM64)
      # -----------------------------
      - name: Build and publish Tauri AppImage (ARM64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: v__VERSION__
          releaseBody: |
            ARM64 (Raspberry Pi OS 64-bit) build.
            Download the `.AppImage` below.
          releaseDraft: false
          prerelease: false
          args: "--target aarch64-unknown-linux-gnu"
